---
title: "Measuring and Mitigating Disparity of Decision-Making Tools"
author: "Ben Brintz"
institute: "Division of Epidemiology"
format: 
  revealjs:
    revealjs-plugins: 
        -plugin
    theme: white
    incremental: true
    slideNumber: true  # Slide numbers (optional)
    transition: fade   # Smooth slide transitions
    title-slide-background: "white" # Ensure title slide background matches your style
    css: custom.css    # Link to your custom CSS file
---



## There is some controversy surrounding the eGFR equation {style="font-size:.75em;" auto-animate=true auto-animate-easing="ease-in-out"}


::: {.r-hstack}
  <img src="egfr1.gif" alt="GIF 1" style="height:160px; width:auto; object-fit:contain;">
  <img src="egfr2.gif" alt="GIF 2" style="height:160px; width:auto; object-fit:contain;">
  <img src="egfr3.gif" alt="GIF 3" style="height:160px; width:auto; object-fit:contain;">
:::

## There is some controversy surrounding the eGFR equation {style="font-size:.75em;" auto-animate=true auto-animate-easing="ease-in-out" visibility="uncounted"}
::: {.r-hstack}
  <img src="egfr1.gif" alt="GIF 1" style="height:160px; width:auto; object-fit:contain;">
  <img src="egfr2.gif" alt="GIF 2" style="height:160px; width:auto; object-fit:contain;">
  <img src="egfr3.gif" alt="GIF 3" style="height:160px; width:auto; object-fit:contain;">
:::
::: {.r-hstack}
  <img src="egfr4.gif" alt="GIF 1" style="height:160px; width:auto; object-fit:contain;">
  <img src="egfr5.gif" alt="GIF 2" style="height:160px; width:auto; object-fit:contain;">
  <img src="egfr6.gif" alt="GIF 3" style="height:160px; width:auto; object-fit:contain;">
:::

## There is some controversy surrounding the eGFR equation {style="font-size:.75em;" auto-animate=true auto-animate-easing="ease-in-out" visibility="uncounted"}
::: {.r-hstack}
  <img src="egfr1.gif" alt="GIF 1" style="height:160px; width:auto; object-fit:contain;">
  <img src="egfr2.gif" alt="GIF 2" style="height:160px; width:auto; object-fit:contain;">
  <img src="egfr3.gif" alt="GIF 3" style="height:160px; width:auto; object-fit:contain;">
:::
::: {.r-hstack}
  <img src="egfr4.gif" alt="GIF 1" style="height:160px; width:auto; object-fit:contain;">
  <img src="egfr5.gif" alt="GIF 2" style="height:160px; width:auto; object-fit:contain;">
  <img src="egfr6.gif" alt="GIF 3" style="height:160px; width:auto; object-fit:contain;">
:::
::: {.r-hstack}
  <img src="egfr7.gif" alt="GIF 1" style="height:160px; width:auto; object-fit:contain;">
  <img src="egfr8.gif" alt="GIF 2" style="height:160px; width:auto; object-fit:contain;">
  <img src="egfr9.gif" alt="GIF 3" style="height:160px; width:auto; object-fit:contain;">
:::

##
### The NKF and ASN have since recommended removal of race from the equation
::: {.incremental}

- Acknowledged race is a social concept 
    - i.e., it's a system to classify individuals rather than reflect biology
    - I have heard the biology is more regional than racial 
-  Does removal of race reduce performance of the decision-making tool?
:::


::: {.fragment .fade-up}
 It depends on how you're measuring performance
:::

---
<div style="font-size: 60px; text-align: center;">Performance metrics are a trade-off </div>
```{r, message=F}
library(tidyverse)
library(pROC)
out=aSAH %>% filter(gender=="Female") %>% roc(outcome,s100b,plot=F,smooth=T)
data.frame(x=out$specificities,y=out$sensitivities) %>%
ggplot(aes(x=1-x,y=y)) + geom_line() + geom_abline(color="grey") + theme_bw() +
ylab("Sensitivity") + xlab("Specificity") + theme(aspect.ratio=.75) +
scale_x_continuous(breaks=c(0,.25,.5,.75,1),labels=rev(c(0,.25,.5,.75,1)))

```
::: {.fragment .fade-in-then-semi-out}
The developer of a tool can choose to emphasize one metric over another 
:::

::: {.fragment .fade-right}
And the choice of metric could be predictive performance or fairness 
:::

##
### Some fairness metrics are more well known than others {.smaller .scrollable}
<style>
.reveal .fragment {
  margin-bottom: 5px; /* Adjust this value to reduce space between fragments */
}
</style>

::: {.fragment  .highlight-current-blue}
\begin{align*}
\text{Statistical Parity} &= P(\widehat{Y}=1|A=a) \\
&= P(\widehat{Y}=1|A=b)
\end{align*}
:::

::: {.fragment .highlight-current-blue}
\begin{align*}
\text{Equalized Odds} &= P(\widehat{Y}=1|A=a,Y=1) \\
&= P(\widehat{Y}=1|A=b,Y=1)
\end{align*}
:::

::: {.fragment .highlight-current-blue}
\begin{align*}
\text{Predictive Parity} &= P(Y=1|\widehat{Y}=1,A=a) \\
&= P(Y=1|\widehat{Y}=1,A=b)
\end{align*}
:::

::: {.fragment .highlight-current-blue}
\begin{align*}
\text{Balance for the Positive Class} &= E(S|Y=1,A=a) \\ &=E(S|Y=1,A=b)
\end{align*}
:::

## {auto-animate="true"}
### The COMPAS data is a landmark dataset to study algorithmic fairness in recidivism prediction 
```r
library(fairness)

head(compas)
```
##{auto-animate="true" visibility="uncounted" .scrollable}
### The COMPAS data is a landmark dataset to study algorithmic fairness in recidivism prediction 
```{r, include=T}
library(fairness)
library(tidyverse)
library(knitr)
library(kableExtra)
head(compas) %>% knitr::kable() %>% kableExtra::kable_styling(full_width = F) #%>% 
  #kableExtra::row_spec(1:6,font_size='medium')
```

## If you can code, measuring fairness is easy {auto-animate="true" .smaller .scrollable}
```r
a=compas %>% group_by(Female) %>% summarize(`Statistical Parity`=mean(predicted))

b=compas %>% filter(Two_yr_Recidivism=="yes") %>% group_by(Female) %>% summarize(`Equalized Odds`=mean(predicted))

c=compas %>% filter(predicted==1) %>% group_by(Female) %>% summarize('Predictive Parity'=mean(Two_yr_Recidivism=="yes"))

d=compas %>% filter(Two_yr_Recidivism=="yes") %>% group_by(Female) %>% summarize('Balance for the Positive Class'=mean(probability))
```

## If you can code, measuring fairness is easy {auto-animate="true" .smaller .scrollable}
```{r,include=T,echo=T}
a=compas %>% group_by(Sex=Female) %>% summarize(`Statistical Parity`=mean(predicted))

b=compas %>% filter(Two_yr_Recidivism=="yes") %>% group_by(Female) %>% summarize(`Equalized Odds`=mean(predicted)) %>% select(-Female)

c=compas %>% filter(predicted==1) %>% group_by(Female) %>% summarize('Predictive Parity'=mean(Two_yr_Recidivism=="yes"))%>% select(-Female)

d=compas %>% filter(Two_yr_Recidivism=="yes") %>% group_by(Female) %>% summarize('Balance for the Positive Class'=mean(probability))%>% select(-Female)

cbind(a,b,c,d) %>% knitr::kable() 
```

## But choosing a metric is hard {auto-animate="true"}
![](fair_diagram.png)

## {auto-animate="true" visibility="uncounted"}
<img src="fair_diagram.png" class="zoom-effect" width="100%">
