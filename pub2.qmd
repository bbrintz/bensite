---
title: "Publication Nebula (Preview)"
format:
  html:
    toc: false
    theme: sandstone
---

```{=html}
<style>
  :root {
    --bg-ink: #071227;
    --ink-2: #0d1d3c;
    --text-main: #f2f7ff;
    --text-dim: #c5d6f3;
    --line-soft: rgba(169, 199, 255, 0.18);
    --chip-bg: rgba(255, 255, 255, 0.06);
    --chip-bg-hover: rgba(144, 200, 255, 0.18);
    --chip-text: #e7f1ff;
    --chip-text-hover: #ffffff;
    --warm: rgba(255, 143, 71, 0.22);
    --cool: rgba(122, 193, 255, 0.22);
  }

  body {
    min-height: 100vh;
    color: var(--text-main);
    background-color: var(--bg-ink);
    background-image:
      radial-gradient(circle at 14% 18%, var(--cool), transparent 36%),
      radial-gradient(circle at 82% 82%, var(--warm), transparent 40%),
      linear-gradient(120deg, #050d20 0%, #0a1731 48%, #0c1f40 100%);
    background-attachment: fixed;
  }

  h1.title {
    color: #f7fbff;
    letter-spacing: 0.01em;
    margin-bottom: 0.35rem;
  }

  .intro-line {
    max-width: 1220px;
    margin: 0 auto 0.8rem auto;
    color: var(--text-dim);
    font-size: 0.98rem;
  }

  .nebula-layout {
    max-width: 1220px;
    margin: 0 auto 2rem auto;
    display: grid;
    grid-template-columns: 1.15fr 0.85fr;
    gap: 1rem;
    align-items: start;
  }

  .cloud-board {
    border-radius: 18px;
    border: 1px solid var(--line-soft);
    background: rgba(255, 255, 255, 0.03);
    padding: 0.85rem;
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 0.85rem;
  }

  .theme-card {
    position: relative;
    border-radius: 14px;
    border: 1px solid rgba(173, 206, 255, 0.16);
    background:
      radial-gradient(circle at 24% 16%, rgba(152, 202, 255, 0.1), rgba(152, 202, 255, 0.01) 48%, transparent 100%),
      rgba(8, 18, 40, 0.64);
    box-shadow: 0 10px 22px rgba(0, 0, 0, 0.24);
    padding: 0.72rem;
    overflow: hidden;
    animation: drift 10s ease-in-out infinite;
    animation-delay: var(--delay);
  }

  .theme-head {
    display: flex;
    justify-content: space-between;
    gap: 0.6rem;
    margin-bottom: 0.55rem;
    align-items: baseline;
  }

  .theme-name {
    font-size: 0.74rem;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: #cfe4ff;
    font-weight: 700;
    line-height: 1.1;
  }

  .theme-count {
    font-size: 0.7rem;
    color: #9ec1ec;
    white-space: nowrap;
  }

  .chip-cloud {
    display: flex;
    flex-wrap: wrap;
    gap: 0.34rem;
    align-items: flex-start;
  }

  .pub-chip {
    border: 1px solid rgba(188, 216, 255, 0.2);
    background: var(--chip-bg);
    color: var(--chip-text);
    border-radius: 999px;
    padding: 0.2rem 0.42rem;
    line-height: 1.15;
    font-weight: 500;
    font-size: calc(var(--fs) * 1rem);
    text-decoration: none;
    transition: transform 180ms ease, background-color 180ms ease, border-color 180ms ease, color 180ms ease, opacity 180ms ease;
    opacity: 0.92;
    transform-origin: center;
    max-width: 100%;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .pub-chip:hover,
  .pub-chip:focus-visible,
  .pub-chip.active {
    transform: translateY(-1px) scale(1.08);
    background: var(--chip-bg-hover);
    border-color: rgba(172, 216, 255, 0.56);
    color: var(--chip-text-hover);
    opacity: 1;
    outline: none;
  }

  .focus-panel {
    position: sticky;
    top: 1rem;
    border-radius: 18px;
    border: 1px solid var(--line-soft);
    background:
      radial-gradient(circle at 86% 12%, rgba(255, 150, 86, 0.14), transparent 36%),
      radial-gradient(circle at 12% 84%, rgba(121, 193, 255, 0.14), transparent 34%),
      rgba(6, 15, 34, 0.78);
    padding: 1rem;
    min-height: 480px;
  }

  .focus-kicker {
    color: #9ec1ec;
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 0.07em;
    margin-bottom: 0.42rem;
    font-weight: 700;
  }

  .focus-title {
    font-size: clamp(1.06rem, 2.4vw, 1.38rem);
    line-height: 1.28;
    margin-bottom: 0.62rem;
    color: #f7fbff;
    font-weight: 700;
  }

  .focus-meta {
    color: #c5d6f3;
    font-size: 0.92rem;
    line-height: 1.42;
    margin-bottom: 0.82rem;
  }

  .focus-link {
    display: inline-block;
    color: #f9fcff;
    text-decoration: none;
    background: linear-gradient(135deg, #62b0ff 0%, #2f7de0 100%);
    border-radius: 999px;
    padding: 0.42rem 0.78rem;
    font-weight: 600;
    box-shadow: 0 10px 22px rgba(47, 125, 224, 0.3);
  }

  .focus-link:hover {
    filter: brightness(1.06);
  }

  .focus-theme-summary {
    margin-top: 1.05rem;
    padding-top: 0.75rem;
    border-top: 1px solid rgba(169, 199, 255, 0.18);
    color: #b8cde9;
    font-size: 0.86rem;
  }

  .focus-theme-summary ul {
    margin: 0.45rem 0 0 1rem;
    padding: 0;
  }

  .focus-theme-summary li {
    margin-bottom: 0.28rem;
  }

  @keyframes drift {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-4px); }
  }

  @media (prefers-reduced-motion: reduce) {
    .theme-card,
    .pub-chip {
      animation: none;
      transition: none;
    }
  }

  @media (max-width: 1040px) {
    .nebula-layout {
      grid-template-columns: 1fr;
    }

    .focus-panel {
      position: static;
      min-height: 0;
    }
  }

  @media (max-width: 720px) {
    .cloud-board {
      grid-template-columns: 1fr;
    }
  }
</style>
```

```{r, include=FALSE, message=FALSE, warning=FALSE}
library(dplyr)
library(glue)
library(htmltools)
library(scholar)
library(stringr)
library(tibble)

scholar_id <- "nYA8PAsAAAAJ"
raw <- get_publications(scholar_id)

normalize_title <- function(x) {
  x |>
    str_to_lower() |>
    str_replace_all("[^a-z0-9 ]", " ") |>
    str_squish()
}

is_probable_conference_abstract <- function(title, journal) {
  s <- str_to_lower(paste(title, journal, sep = " "))
  str_detect(
    s,
    "\\b(abstract|conference|proceedings|symposium|workshop|annual meeting|poster|meeting abstract|conference abstract)\\b"
  )
}

theme_for <- function(title, journal) {
  text <- str_to_lower(paste(title, journal, sep = " "))
  case_when(
    str_detect(text, "diarrhea|diarrhoea|etiology|enteric|pediatric|children|gems") ~ "Diarrhea & Infectious Disease",
    str_detect(text, "n-mixture|asymptotic|statistical|bayesian|spatially explicit|prevalence") ~ "Statistical Methods",
    str_detect(text, "machine learning|ai|predict|prediction|clinical decision|telemedicine|model") ~ "AI & Clinical Prediction",
    str_detect(text, "covid|sars|pandemic|outpatient|testing") ~ "COVID & Public Health",
    str_detect(text, "antibiotic|resistance|enterobacterales|stewardship|urinary tract") ~ "AMR & Stewardship",
    str_detect(text, "cataract|phacoemulsification|corneal|ophthalm") ~ "Surgery & Ophthalmology",
    TRUE ~ "Other Applied Research"
  )
}

rescale_to <- function(x, min_out, max_out) {
  if (all(is.na(x)) || length(unique(x[is.finite(x)])) <= 1) {
    return(rep((min_out + max_out) / 2, length(x)))
  }
  rng <- range(x, na.rm = TRUE)
  (x - rng[1]) / (rng[2] - rng[1]) * (max_out - min_out) + min_out
}

clean <- raw |>
  mutate(
    year = suppressWarnings(as.integer(year)),
    year = if_else(is.na(year), as.integer(format(Sys.Date(), "%Y")), year),
    cites = suppressWarnings(as.integer(cites)),
    cites = if_else(is.na(cites), 0L, cites),
    norm_title = normalize_title(title)
  ) |>
  arrange(desc(cites), desc(year)) |>
  distinct(norm_title, .keep_all = TRUE) |>
  filter(!is_probable_conference_abstract(title, journal)) |>
  mutate(
    theme = theme_for(title, journal),
    link = glue("https://scholar.google.com/citations?view_op=view_citation&user={scholar_id}&citation_for_view={scholar_id}:{pubid}"),
    recency = pmax(0, year - 2015),
    weight = log1p(cites) + recency / 13,
    fs = rescale_to(weight, 0.56, 0.86),
    short_title = if_else(str_length(title) > 44, str_c(str_sub(title, 1, 41), "..."), title)
  )

# Keep page neat while still broad.
cloud <- clean |> slice_head(n = min(120, nrow(clean)))

theme_summary <- cloud |>
  count(theme, sort = TRUE) |>
  mutate(label = glue("{theme} ({n})"))

summary_strip <- glue(
  "<div class='intro-line'>Pulled <strong>{nrow(raw)}</strong> Scholar records, deduplicated to <strong>{n_distinct(normalize_title(raw$title))}</strong>, filtered to <strong>{nrow(clean)}</strong> likely full publications, and rendered <strong>{nrow(cloud)}</strong> titles in this interactive preview.</div>"
)

first_rec <- cloud |> arrange(desc(weight), desc(cites), desc(year)) |> slice(1)
```

```{r, results='asis', echo=FALSE, message=FALSE, warning=FALSE}
cat(summary_strip, "\n")

cat("<div class='nebula-layout'>\n")
cat("<section class='cloud-board' id='cloud-board'>\n")

by_theme <- cloud |>
  arrange(theme, desc(weight), desc(cites), desc(year)) |>
  group_split(theme)

for (i in seq_along(by_theme)) {
  block <- by_theme[[i]]
  th <- block$theme[1]
  drift_delay <- sprintf("%.2fs", (i - 1) * 0.38)
  count <- nrow(block)

  cat(glue(
    "<article class='theme-card' style='--delay:{drift_delay};' data-theme='{htmlEscape(th, attribute = TRUE)}'>",
    "<div class='theme-head'><div class='theme-name'>{htmlEscape(th)}</div><div class='theme-count'>{count} pubs</div></div>",
    "<div class='chip-cloud'>"
  ))

  for (j in seq_len(nrow(block))) {
    r <- block[j, ]
    chip <- glue(
      "<a class='pub-chip'",
      " data-theme='{htmlEscape(r$theme, attribute = TRUE)}'",
      " data-title='{htmlEscape(r$title, attribute = TRUE)}'",
      " data-year='{r$year}'",
      " data-cites='{r$cites}'",
      " data-journal='{htmlEscape(r$journal, attribute = TRUE)}'",
      " href='{htmlEscape(r$link, attribute = TRUE)}' target='_blank' rel='noopener'",
      " style='--fs:{sprintf('%.3f', r$fs)};'>",
      "{htmlEscape(r$short_title)}",
      "</a>"
    )
    cat(chip)
  }

  cat("</div></article>\n")
}

cat("</section>\n")

# Right-side focus panel
cat(glue(
  "<aside class='focus-panel' id='focus-panel'>",
  "<div class='focus-kicker' id='focus-kicker'>{htmlEscape(first_rec$theme)}</div>",
  "<div class='focus-title' id='focus-title'>{htmlEscape(first_rec$title)}</div>",
  "<div class='focus-meta' id='focus-meta'><strong>{htmlEscape(first_rec$journal)}</strong><br>{first_rec$year} · {first_rec$cites} citations</div>",
  "<a class='focus-link' id='focus-link' href='{htmlEscape(first_rec$link, attribute = TRUE)}' target='_blank' rel='noopener'>Open on Scholar</a>",
  "<div class='focus-theme-summary'><strong>Theme Coverage</strong><ul>",
  paste0(vapply(theme_summary$label, function(lbl) glue("<li>{htmlEscape(lbl)}</li>"), character(1)), collapse = ""),
  "</ul></div>",
  "</aside>"
))

cat("</div>\n")

cat(
  "<script>",
  "(function(){",
  "const chips = Array.from(document.querySelectorAll('.pub-chip'));",
  "const kicker = document.getElementById('focus-kicker');",
  "const title = document.getElementById('focus-title');",
  "const meta = document.getElementById('focus-meta');",
  "const link = document.getElementById('focus-link');",
  "if(!chips.length || !kicker || !title || !meta || !link) return;",
  "",
  "function setActive(el){",
  "  chips.forEach(c => c.classList.remove('active'));",
  "  el.classList.add('active');",
  "  kicker.textContent = el.dataset.theme || '';",
  "  title.textContent = el.dataset.title || '';",
  "  const j = el.dataset.journal || '';",
  "  const y = el.dataset.year || '';",
  "  const c = el.dataset.cites || '0';",
  "  meta.innerHTML = '<strong>' + j + '</strong><br>' + y + ' · ' + c + ' citations';",
  "  link.href = el.href;",
  "}",
  "",
  "chips.forEach((el)=>{",
  "  el.addEventListener('mouseenter', ()=>setActive(el));",
  "  el.addEventListener('focusin', ()=>setActive(el));",
  "});",
  "",
  "setActive(chips[0]);",
  "})();",
  "</script>",
  sep = ""
)
```
